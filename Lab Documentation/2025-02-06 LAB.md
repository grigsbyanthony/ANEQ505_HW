```bash
sinteractive --reservation=aneq505 --time=01:00:00 --partition=amilan --nodes=1 --ntasks=6 --qos=normal

module purge

module load qiime2/2024.10_amplicon

cd /scratch/alpine/$USER/

mkdir decomp_tutorial
cd decomp_tutorial  
pwd

mkdir slurm
mkdir taxonomy
mkdir tree
mkdir taxaplots
mkdir dada2
mkdir demux

# Redundant command
mkdir core_metrics

mkdir manifest
cd manifest
cp /pl/active/courses/2025_summer/CSU_2025/q2_workshop_final/QIIME2/manifest_run2.txt .
cp /pl/active/courses/2025_summer/CSU_2025/q2_workshop_final/QIIME2/manifest_run3.txt .
cp -r /pl/active/courses/2025_summer/CSU_2025/q2_workshop_final/QIIME2/reads_run2 .
cp -r /pl/active/courses/2025_summer/CSU_2025/q2_workshop_final/QIIME2/reads_run3 .

# Review data
cd reads_run2
ls

# Import `run 2` 
qiime tools import \  
--type "SampleData[PairedEndSequencesWithQuality]" \  
--input-format PairedEndFastqManifestPhred33V2 \  
--input-path manifest_run2.txt \  
--output-path demux_run2.qza  
  
# Import `run 3`  
qiime tools import \  
--type "SampleData[PairedEndSequencesWithQuality]" \  
--input-format PairedEndFastqManifestPhred33V2 \  
--input-path manifest_run3.txt \  
--output-path demux_run3.qza

# Data quality for `run 2`  
qiime demux summarize \  
--i-data demux_run2.qza \  
--o-visualization demux_run2.qzv  
  
#Data quality for `run 3`  
qiime demux summarize \  
--i-data demux_run3.qza \  
--o-visualization demux_run3.qzv

# Moving onto denoising
cd ..
ls
ls demux

mv manifest/demux_run2.qza demux/
mv manifest/demux_run3.qza demux/

cp demux/demux_run2.qza dada2/
cp demux/demux_run3.qza dada2/
  
cd dada2

# Denoising takes too long to practically do in class but here's what you can run if you want to try it
# Denoise `run 2`
qiime dada2 denoise-paired \  
--i-demultiplexed-seqs demux_run2.qza \  
--p-trunc-len-f 150 \  
--p-trunc-len-r 150 \  
--p-n-threads 8 \  
--o-table table_run2.qza \  
--o-representative-sequences seqs_run2.qza \  
--o-denoising-stats dada2_stats_run2.qza  
  
# Denoise `run 3`  
qiime dada2 denoise-paired \  
--i-demultiplexed-seqs ../demux_run3.qza \  
--p-trunc-len-f 150 \  
--p-trunc-len-r 150 \  
--p-n-threads 8 \  
--o-table table_run3.qza \  
--o-representative-sequences seqs_run3.qza \  
--o-denoising-stats dada2_stats_run3.qza

qiime metadata tabulate \  
 --m-input-file dada2_stats_run2.qza \  
 --o-visualization dada2_stats_run2.qzv  
  
qiime metadata tabulate \  
 --m-input-file dada2_stats_run3.qza \  
 --o-visualization dada2_stats_run3.qzv
 
mv table_run2.qza dada2/
mv seqs_run2.qza dada2/
mv dada2_stats_run2.qza dada2/
mv dada2_stats_run2.qzv dada2/
mv table_run3.qza dada2/
mv seqs_run3.qza dada2/
mv dada2_stats_run3.qza dada2/
mv dada2_stats_run3.qzv dada2/

rm table_run2.qza
rm seqs_run2.qza
rm dada2_stats_run2.qza
rm table_run3.qza
rm seqs_run3.qza
rm dada2_stats_run3.qza
rm dada2_stats_run2.qzv 
rm dada2_stats_run3.qzv 

# Moving over to /dada2/
cd ../
cd dada2
ls 

qiime feature-table merge \  
--i-tables table_run2.qza \  
--i-tables table_run3.qza \  
--o-merged-table table.qza  
  
qiime feature-table summarize \  
--i-table table.qza \  
--o-visualization table.qzv \  
--m-sample-metadata-file ../metadata/metadata.txt

qiime feature-table merge-seqs \  
--i-data seqs_run2.qza \  
--i-data seqs_run3.qza \  
--o-merged-data seqs.qza  
  
qiime feature-table tabulate-seqs \  
--i-data seqs.qza \  
--o-visualization seqs.qzv
```